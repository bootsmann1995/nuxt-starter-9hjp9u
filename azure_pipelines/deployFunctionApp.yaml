parameters:
  - name: environment
    type: string
  # - name: domain
  #   type: string
  - name: appName
    type: string
  - name: azureResourceManagerConnection
    type: string
  - name: azureSubscriptionId
    type: string
  - name: armTemplateFile
    type: string
  - name: armParameterFile
    type: string
  - name: resourceGroupName
    type: string
  - name: vaultName
    type: string
  - name: outDir
    type: string

steps:
  - task: AzureResourceManagerTemplateDeployment@3
    inputs:
      deploymentScope: "Subscription"
      deploymentMode: "Incremental"
      azureResourceManagerConnection: ${{parameters.azureResourceManagerConnection}}
      subscriptionId: ${{parameters.azureSubscriptionId}}
      location: "North Europe"
      templateLocation: "Linked artifact"
      csmFile: ${{parameters.armTemplateFile}}
      csmParametersFile: ${{parameters.armParameterFile}}
      overrideParameters:
        '-environment "${{parameters.environment}}"
        -resourceGroupName "${{parameters.resourceGroupName}}"
        -vaultName "${{parameters.vaultName}}"
        -appName "${{parameters.appName}}"
        -storageConnectionSecret storageConnectionStringKey'
        # -domainNames ${{parameters.domain}}

  - task: AzureFunctionApp@1
    inputs:
      azureSubscription: ${{parameters.azureResourceManagerConnection}}
      appType: "functionAppLinux"
      appName: "func-${{parameters.appName}}"
      package: "$(Pipeline.Workspace)/drop/${{parameters.outDir}}.zip"
      runtimeStack: "NODE|14"
    #  appSettings: '-CONTENTFUL_TOKEN $(contentfulToken)'
